{% extends "base.html" %}

{% block title %}Calendar - {{ month_names[current_month-1] }} {{ current_year }}{% endblock %}

{% block head %}
<style>
    /* Navigation button loading states */
    .nav-loading {
        opacity: 0.7;
        cursor: wait;
        transform: scale(0.98);
    }
    
    /* Smooth transitions for navigation */
    .nav-button {
        transition: all 0.2s ease-in-out;
    }
    
    /* Loading spinner for navigation buttons */
    .nav-button:disabled::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255,255,255,0.3);
        border-top: 2px solid white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: translate(-50%, -50%) rotate(0deg); }
        100% { transform: translate(-50%, -50%) rotate(360deg); }
    }
    
    /* Smooth page transitions */
    body {
        transition: opacity 0.1s ease-in-out;
    }
    
    /* Highlight focused date */
    .focused-date {
        animation: focusPulse 2s ease-in-out;
        box-shadow: 0 0 20px rgba(59, 130, 246, 0.6) !important;
        border: 3px solid rgba(59, 130, 246, 0.8) !important;
    }
    
    /* Today marker (when not focused) */
    .calendar-day.border-green-400 {
        position: relative;
    }
    
    .calendar-day.border-green-400::after {
        content: '‚óè';
        position: absolute;
        top: 2px;
        right: 4px;
        color: #22c55e;
        font-size: 8px;
        font-weight: bold;
    }
    
    @keyframes focusPulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.02); }
    }
</style>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Privacy Policy Banner -->
    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 border-2 border-blue-200 dark:border-blue-700 rounded-xl p-4 shadow-lg">
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <svg class="h-6 w-6 text-blue-600 dark:text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                    </svg>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-semibold text-blue-800 dark:text-blue-200">
                        üîí Ch√≠nh s√°ch b·∫£o m·∫≠t & Quy·ªÅn ri√™ng t∆∞
                    </h3>
                    <p class="text-xs text-blue-700 dark:text-blue-300 mt-1">
                        Ch√∫ng t√¥i cam k·∫øt b·∫£o v·ªá th√¥ng tin c√° nh√¢n c·ªßa b·∫°n. 
                        <a href="/privacy" class="font-medium underline hover:no-underline text-blue-800 dark:text-blue-200">Xem chi ti·∫øt</a>
                    </p>
                </div>
            </div>
            <div class="flex-shrink-0">
                <a href="/privacy" class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium rounded-lg shadow-sm hover:shadow-md transition-all duration-200">
                    Xem ch√≠nh s√°ch
                </a>
            </div>
        </div>
    </div>

    <!-- Birth Date Missing Alert for Logged In Users -->
    {% if current_user and not current_user.birth_date %}
    <div class="bg-gradient-to-r from-yellow-50 to-orange-50 dark:from-yellow-900/20 dark:to-orange-900/20 border-2 border-yellow-200 dark:border-yellow-700 rounded-xl p-4 shadow-lg">
        <div class="flex items-start">
            <div class="flex-shrink-0">
                <svg class="h-6 w-6 text-yellow-600 dark:text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z" />
                </svg>
            </div>
            <div class="ml-3 flex-1">
                <h3 class="text-sm font-semibold text-yellow-800 dark:text-yellow-200">
                    üéÇ C·∫≠p nh·∫≠t ng√†y sinh ƒë·ªÉ s·ª≠ d·ª•ng t√≠nh nƒÉng phong th·ªßy c√° nh√¢n
                </h3>
                <div class="mt-1 text-xs text-yellow-700 dark:text-yellow-300">
                    <p class="mb-2">
                        Ch√∫ng t√¥i ch∆∞a c√≥ th√¥ng tin ng√†y sinh c·ªßa b·∫°n. 
                        <a href="/profile" class="font-medium underline hover:no-underline">Xem h∆∞·ªõng d·∫´n c·∫≠p nh·∫≠t</a>
                    </p>
                </div>
            </div>
            <div class="ml-3 flex-shrink-0">
                <button onclick="this.parentElement.parentElement.parentElement.style.display='none'" 
                        class="text-yellow-600 hover:text-yellow-800 dark:text-yellow-400 dark:hover:text-yellow-200">
                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Calendar Header -->
    <div class="bg-gradient-to-r from-white to-blue-50 dark:from-gray-800 dark:to-gray-700 rounded-xl shadow-lg border border-blue-200 dark:border-gray-600 p-6">
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 space-y-4 sm:space-y-0">
            <!-- Title -->
            <div class="flex items-center flex-col sm:flex-row">
                <h1 class="text-2xl sm:text-3xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent dark:from-blue-400 dark:to-purple-400">
                    {{ today.strftime('%d') }} {{ month_names[current_month-1] }} {{ current_year }}
                </h1>
                {% if today != real_today %}
                <div class="ml-0 sm:ml-4 mt-1 sm:mt-0">
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200">
                        üìç ƒê√£ ch·ªçn: {{ today.strftime('%d/%m/%Y') }}
                    </span>
                </div>
                {% endif %}
            </div>

            <!-- Navigation Buttons -->
            <div class="flex items-center space-x-1 sm:space-x-2">
                {% set yesterday = today - timedelta(days=1) %}
                {% set tomorrow = today + timedelta(days=1) %}
                
                <!-- Previous Day -->
                <button hx-get="/navigate-day/{{ yesterday.strftime('%Y-%m-%d') }}"
                        hx-target="body"
                        hx-swap="outerHTML"
                        hx-push-url="/?focus_date={{ yesterday.strftime('%Y-%m-%d') }}"
                        class="nav-button relative p-3 rounded-xl bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105"
                        title="H√¥m qua: {{ yesterday.strftime('%d/%m/%Y') }}">
                    <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </button>

                <!-- Today -->
                <button hx-get="/"
                        hx-target="body"
                        hx-swap="outerHTML"
                        hx-push-url="/"
                        class="nav-button relative px-4 sm:px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white rounded-xl text-xs sm:text-sm font-bold shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105">
                    <span class="hidden sm:inline">üè† H√¥m nay</span>
                    <span class="sm:hidden">üè†</span>
                </button>

                <!-- Next Day -->
                <button hx-get="/navigate-day/{{ tomorrow.strftime('%Y-%m-%d') }}"
                        hx-target="body"
                        hx-swap="outerHTML"
                        hx-push-url="/?focus_date={{ tomorrow.strftime('%Y-%m-%d') }}"
                        class="nav-button relative p-3 rounded-xl bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105"
                        title="Ng√†y mai: {{ tomorrow.strftime('%d/%m/%Y') }}">
                    <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- Add Note Button & Month/Year Selectors -->
        <div class="mb-4 flex flex-col sm:flex-row items-start sm:items-center justify-between space-y-4 sm:space-y-0">
            <!-- Add Note Button -->
            <button id="toggle-note-form"
                    onclick="toggleNoteForm()"
                    class="inline-flex items-center px-4 sm:px-6 py-3 bg-gradient-to-r from-purple-500 to-pink-600 hover:from-purple-600 hover:to-pink-700 text-white rounded-xl text-xs sm:text-sm font-bold shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105">
                <svg id="add-icon" class="w-4 h-4 sm:w-5 sm:h-5 mr-1 sm:mr-2 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                <span class="hidden sm:inline">‚ú® <span id="button-text">Th√™m ghi ch√∫</span></span>
                <span class="sm:hidden" id="button-icon">‚ûï</span>
            </button>

            <!-- Month/Year Selectors -->
            <div class="flex items-center space-x-2">
                    <select id="month-selector" onchange="changeDate()"
                            class="px-3 py-2 bg-white dark:bg-gray-700 border-2 border-blue-300 dark:border-gray-600 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                        {% for i in range(1, 13) %}
                        <option value="{{ i }}" {% if i == current_month %}selected{% endif %}>
                            {{ month_names[i-1] }}
                        </option>
                        {% endfor %}
                    </select>

                    <select id="year-selector" onchange="changeDate()"
                            class="px-3 py-2 bg-white dark:bg-gray-700 border-2 border-blue-300 dark:border-gray-600 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                        {% for year in range(current_year-5, current_year+6) %}
                        <option value="{{ year }}" {% if year == current_year %}selected{% endif %}>
                            {{ year }}
                        </option>
                        {% endfor %}
                    </select>
            </div>
        </div>
        
        <!-- Note Form Container -->
        <div id="note-form-container" class="mb-4"></div>
    </div>

    <!-- Main Content Layout with Sidebar -->
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
        <!-- Calendar Grid (Main Content) -->
        <div class="lg:col-span-3">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl border-2 border-blue-100 dark:border-gray-600 overflow-hidden">
        <!-- Weekday Headers -->
        <div class="grid grid-cols-7 bg-gradient-to-r from-blue-500 to-purple-600 dark:from-gray-700 dark:to-gray-600">
            {% for weekday in weekday_names %}
            <div class="p-2 sm:p-3 text-center text-xs sm:text-sm font-bold text-white dark:text-gray-200 border-r border-blue-400 dark:border-gray-500 last:border-r-0">
                <span class="hidden sm:inline">{{ weekday }}</span>
                <span class="sm:hidden">{{ weekday[:1] }}</span>
            </div>
            {% endfor %}
        </div>
        
        <!-- Calendar Days -->
        {% for week in calendar_weeks %}
        <div class="grid grid-cols-7 border-t border-gray-200 dark:border-gray-600">
            {% for day in week %}
            <div class="calendar-day border-r border-blue-100 dark:border-gray-600 last:border-r-0 p-1 sm:p-2
                        {% if not day.is_current_month %}bg-gray-100 dark:bg-gray-700{% endif %}
                        {% if day.is_focused %}bg-gradient-to-br from-yellow-200 to-orange-300 dark:from-blue-800 dark:to-blue-900 shadow-inner focused-date{% endif %}
                        {% if day.is_today and not day.is_focused %}border-2 border-green-400 dark:border-green-500{% endif %}
                        relative transition-all duration-200 cursor-pointer"
                 data-date="{{ day.date.strftime('%d/%m/%Y') }}"
                 {% if day.notes %}
                 data-tooltip="üìù Ghi ch√∫: {{ day.notes[0].content[:100] }}{% if day.notes[0].content|length > 100 %}...{% endif %}"
                 {% else %}
                 data-tooltip="üìÖ {{ day.date.strftime('%d/%m/%Y') }} - üåô {{ day.lunar_date_str }}"
                 {% endif %}>
                
                <!-- Date Number -->
                <div class="flex items-center justify-between mb-1">
                    <span class="text-sm sm:text-lg lg:text-xl font-bold
                                {% if not day.is_current_month %}text-gray-400 dark:text-gray-500{% else %}text-gray-900 dark:text-white{% endif %}
                                {% if day.is_focused %}text-blue-700 dark:text-blue-300 font-extrabold{% endif %}
                                {% if day.is_today and not day.is_focused %}text-green-600 dark:text-green-400{% endif %}">
                        {{ day.day }}
                    </span>

                    <!-- Note indicator -->
                    {% set date_str = day.date.strftime('%Y-%m-%d') %}
                    {% if date_str in notes_by_date %}
                    <div class="note-indicator"></div>
                    {% endif %}
                </div>

                <!-- Lunar Date -->
                <div class="lunar-date text-red-500 dark:text-red-400 text-xs sm:text-sm font-medium">
                    <span class="hidden sm:inline">{{ day.lunar_day }}/{{ day.lunar_month }}</span>
                    <span class="sm:hidden">{{ day.lunar_day }}</span>
                    {% if day.is_leap_month %}<span class="hidden sm:inline"> (nhu·∫≠n)</span>{% endif %}
                </div>
                
                <!-- Feng Shui Summary -->
                {% if day.feng_shui_summary %}
                <div class="feng-shui-summary text-xs font-medium mt-1" 
                     title="{{ day.feng_shui_summary }}">
                    {% if current_user and current_user.birth_date %}
                        <!-- Personal feng shui with color coding -->
                        {% if day.feng_shui_summary.startswith('üü¢') %}
                            <div class="bg-green-100 dark:bg-green-800 text-green-800 dark:text-green-200 px-1 py-0.5 rounded truncate">
                                <span class="hidden sm:inline">{{ day.feng_shui_summary }}</span>
                                <span class="sm:hidden">üü¢</span>
                            </div>
                        {% elif day.feng_shui_summary.startswith('üîµ') %}
                            <div class="bg-blue-100 dark:bg-blue-800 text-blue-800 dark:text-blue-200 px-1 py-0.5 rounded truncate">
                                <span class="hidden sm:inline">{{ day.feng_shui_summary }}</span>
                                <span class="sm:hidden">üîµ</span>
                            </div>
                        {% elif day.feng_shui_summary.startswith('üü°') %}
                            <div class="bg-yellow-100 dark:bg-yellow-800 text-yellow-800 dark:text-yellow-200 px-1 py-0.5 rounded truncate">
                                <span class="hidden sm:inline">{{ day.feng_shui_summary }}</span>
                                <span class="sm:hidden">üü°</span>
                            </div>
                        {% elif day.feng_shui_summary.startswith('üî¥') %}
                            <div class="bg-red-100 dark:bg-red-800 text-red-800 dark:text-red-200 px-1 py-0.5 rounded truncate">
                                <span class="hidden sm:inline">{{ day.feng_shui_summary }}</span>
                                <span class="sm:hidden">üî¥</span>
                            </div>
                        {% endif %}
                    {% else %}
                        <!-- General feng shui -->
                        <div class="text-purple-600 dark:text-purple-400 truncate">
                            <span class="hidden sm:inline">{{ day.feng_shui_summary[:25] }}{% if day.feng_shui_summary|length > 25 %}...{% endif %}</span>
                            <span class="sm:hidden">üîÆ</span>
                        </div>
                    {% endif %}
                </div>
                {% endif %}
                
                <!-- Holidays Preview -->
                {% if date_str in holidays_by_date %}
                <div class="mt-1 space-y-1">
                    {% for holiday in holidays_by_date[date_str][:2] %}
                    <div class="text-xs 
                                {% if holiday.type == 'national' %}bg-green-100 dark:bg-green-800 text-green-800 dark:text-green-200{% else %}bg-red-100 dark:bg-red-800 text-red-800 dark:text-red-200{% endif %}
                                px-1 py-0.5 rounded truncate">
                        {% if holiday.type == 'national' %}üáªüá≥{% else %}üèÆ{% endif %} 
                        <span class="hidden sm:inline">{{ holiday.name[:15] }}{% if holiday.name|length > 15 %}...{% endif %}</span>
                        <span class="sm:hidden">{{ holiday.name[:8] }}{% if holiday.name|length > 8 %}...{% endif %}</span>
                    </div>
                    {% endfor %}
                    {% if holidays_by_date[date_str]|length > 2 %}
                    <div class="text-xs text-gray-500 dark:text-gray-400">
                        +{{ holidays_by_date[date_str]|length - 2 }} l·ªÖ kh√°c
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                <!-- Notes Preview -->
                {% if date_str in notes_by_date %}
                <div class="mt-1 space-y-1">
                    {% for note in notes_by_date[date_str][:2] %}
                    <div class="text-xs bg-blue-100 dark:bg-blue-800 text-blue-800 dark:text-blue-200 px-1 py-0.5 rounded truncate">
                        <span class="hidden sm:inline">{{ note.title[:20] }}{% if note.title|length > 20 %}...{% endif %}</span>
                        <span class="sm:hidden">{{ note.title[:10] }}{% if note.title|length > 10 %}...{% endif %}</span>
                    </div>
                    {% endfor %}
                    {% if notes_by_date[date_str]|length > 2 %}
                    <div class="text-xs text-gray-500 dark:text-gray-400">
                        +{{ notes_by_date[date_str]|length - 2 }} ghi ch√∫ kh√°c
                    </div>
                    {% endif %}
                </div>
                {% endif %}
                
                <!-- Click to view day -->
                {% if day.is_current_month %}
                <a href="/day/{{ day.date.strftime('%Y-%m-%d') }}"
                   class="absolute inset-0 z-10"></a>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% endfor %}
            </div>
        </div>

        <!-- Personal Feng Shui Sidebar -->
        <div class="lg:col-span-1">
            {% if personal_feng_shui_today %}
            <div class="bg-gradient-to-br from-purple-50 to-indigo-50 dark:from-purple-900/20 dark:to-indigo-900/20 rounded-xl shadow-lg border-2 border-purple-200 dark:border-purple-700 p-4 sticky top-4">
                <div class="text-center mb-4">
                    <h3 class="text-lg font-bold bg-gradient-to-r from-purple-600 to-indigo-600 bg-clip-text text-transparent dark:from-purple-400 dark:to-indigo-400">
                        üîÆ Phong th·ªßy h√¥m nay
                    </h3>
                    <p class="text-sm text-purple-600 dark:text-purple-300">
                        {{ today.strftime('%d/%m/%Y') }}
                    </p>
                </div>

                <!-- Birthday Reminder -->
                {% if personal_feng_shui_today.birthday_reminder %}
                <div class="mb-4 p-3 bg-gradient-to-r from-pink-100 to-purple-100 dark:from-pink-900/30 dark:to-purple-900/30 rounded-lg border border-pink-300 dark:border-pink-700">
                    <div class="text-center">
                        <div class="text-lg mb-1">{{ personal_feng_shui_today.birthday_reminder.message }}</div>
                        <p class="text-xs text-pink-700 dark:text-pink-300">{{ personal_feng_shui_today.birthday_reminder.advice }}</p>
                    </div>
                </div>
                {% endif %}

                <!-- Compatibility Score -->
                <div class="mb-4 p-3 rounded-lg border 
                            {% if personal_feng_shui_today.compatibility.score >= 80 %}
                                bg-green-50 dark:bg-green-900/30 border-green-300 dark:border-green-700
                            {% elif personal_feng_shui_today.compatibility.score >= 60 %}
                                bg-blue-50 dark:bg-blue-900/30 border-blue-300 dark:border-blue-700
                            {% elif personal_feng_shui_today.compatibility.score >= 40 %}
                                bg-yellow-50 dark:bg-yellow-900/30 border-yellow-300 dark:border-yellow-700
                            {% else %}
                                bg-red-50 dark:bg-red-900/30 border-red-300 dark:border-red-700
                            {% endif %}">
                    <div class="text-center">
                        <h4 class="text-sm font-semibold mb-1
                                   {% if personal_feng_shui_today.compatibility.score >= 80 %}
                                       text-green-800 dark:text-green-200
                                   {% elif personal_feng_shui_today.compatibility.score >= 60 %}
                                       text-blue-800 dark:text-blue-200
                                   {% elif personal_feng_shui_today.compatibility.score >= 40 %}
                                       text-yellow-800 dark:text-yellow-200
                                   {% else %}
                                       text-red-800 dark:text-red-200
                                   {% endif %}">
                            üìä {{ personal_feng_shui_today.compatibility.level }}
                        </h4>
                        <div class="text-xl font-bold mb-2
                                    {% if personal_feng_shui_today.compatibility.score >= 80 %}
                                        text-green-600 dark:text-green-400
                                    {% elif personal_feng_shui_today.compatibility.score >= 60 %}
                                        text-blue-600 dark:text-blue-400
                                    {% elif personal_feng_shui_today.compatibility.score >= 40 %}
                                        text-yellow-600 dark:text-yellow-400
                                    {% else %}
                                        text-red-600 dark:text-red-400
                                    {% endif %}">
                            {{ personal_feng_shui_today.compatibility.score }}/100
                        </div>
                        <p class="text-xs
                                  {% if personal_feng_shui_today.compatibility.score >= 80 %}
                                      text-green-700 dark:text-green-300
                                  {% elif personal_feng_shui_today.compatibility.score >= 60 %}
                                      text-blue-700 dark:text-blue-300
                                  {% elif personal_feng_shui_today.compatibility.score >= 40 %}
                                      text-yellow-700 dark:text-yellow-300
                                  {% else %}
                                      text-red-700 dark:text-red-300
                                  {% endif %}">
                            {{ personal_feng_shui_today.compatibility.analysis }}
                        </p>
                    </div>
                </div>

                <!-- Personal Info -->
                <div class="mb-4 p-3 bg-gradient-to-br from-purple-100 to-purple-200 dark:from-purple-900/30 dark:to-purple-800/30 rounded-lg border border-purple-300 dark:border-purple-700">
                    <h4 class="text-sm text-purple-600 dark:text-purple-400 font-medium mb-2">üë§ Th√¥ng tin c√° nh√¢n</h4>
                    <div class="space-y-1 text-xs">
                        <div><strong>M·ªánh:</strong> {{ personal_feng_shui_today.user_info.birth_year_element }}</div>
                        <div><strong>Tu·ªïi:</strong> {{ personal_feng_shui_today.user_info.zodiac }}</div>
                    </div>
                </div>

                <!-- Day Info -->
                <div class="mb-4 p-3 bg-gradient-to-br from-indigo-100 to-indigo-200 dark:from-indigo-900/30 dark:to-indigo-800/30 rounded-lg border border-indigo-300 dark:border-indigo-700">
                    <h4 class="text-sm text-indigo-600 dark:text-indigo-400 font-medium mb-2">üìÖ Th√¥ng tin ng√†y</h4>
                    <div class="space-y-1 text-xs">
                        <div><strong>Can Chi:</strong> {{ personal_feng_shui_today.day_info.can_chi }}</div>
                        <div><strong>Ng≈© h√†nh:</strong> {{ personal_feng_shui_today.day_info.element.value }}</div>
                        <div><strong>H∆∞·ªõng t·ªët:</strong> {{ personal_feng_shui_today.day_info.lucky_direction }}</div>
                    </div>
                </div>

                <!-- Personal Activities -->
                <div class="mb-4">
                    <div class="p-3 bg-gradient-to-br from-green-100 to-emerald-100 dark:from-green-900/30 dark:to-emerald-900/30 rounded-lg border border-green-300 dark:border-green-700 mb-2">
                        <h4 class="text-sm font-semibold text-green-800 dark:text-green-200 mb-2">‚úÖ N√™n l√†m</h4>
                        <ul class="space-y-1">
                            {% for activity in personal_feng_shui_today.personal_advice.activities.recommended[:3] %}
                            <li class="text-xs text-green-700 dark:text-green-300 flex items-start">
                                <span class="text-green-500 mr-1">‚Ä¢</span>
                                {{ activity }}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    
                    {% if personal_feng_shui_today.personal_advice.activities.avoid %}
                    <div class="p-3 bg-gradient-to-br from-red-100 to-pink-100 dark:from-red-900/30 dark:to-pink-900/30 rounded-lg border border-red-300 dark:border-red-700">
                        <h4 class="text-sm font-semibold text-red-800 dark:text-red-200 mb-2">‚ùå N√™n tr√°nh</h4>
                        <ul class="space-y-1">
                            {% for activity in personal_feng_shui_today.personal_advice.activities.avoid[:3] %}
                            <li class="text-xs text-red-700 dark:text-red-300 flex items-start">
                                <span class="text-red-500 mr-1">‚Ä¢</span>
                                {{ activity }}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                </div>

                <!-- Personal Colors -->
                <div class="mb-4 p-3 bg-gradient-to-br from-yellow-100 to-orange-100 dark:from-yellow-900/30 dark:to-orange-900/30 rounded-lg border border-yellow-300 dark:border-yellow-700">
                    <h4 class="text-sm font-semibold text-yellow-800 dark:text-yellow-200 mb-2">üé® M√†u may m·∫Øn</h4>
                    <div class="flex flex-wrap gap-1">
                        {% for color in personal_feng_shui_today.personal_advice.colors[:4] %}
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-200 dark:bg-yellow-800 text-yellow-800 dark:text-yellow-200">
                            {{ color }}
                        </span>
                        {% endfor %}
                    </div>
                </div>

                <!-- Lucky Hours -->
                <div class="mb-4 p-3 bg-gradient-to-br from-blue-100 to-cyan-100 dark:from-blue-900/30 dark:to-cyan-900/30 rounded-lg border border-blue-300 dark:border-blue-700">
                    <h4 class="text-sm font-semibold text-blue-800 dark:text-blue-200 mb-2">‚è∞ Gi·ªù ho√†ng ƒë·∫°o</h4>
                    <div class="grid grid-cols-2 gap-1">
                        {% for hour in personal_feng_shui_today.day_info.lucky_hours[:4] %}
                        <div class="text-xs bg-blue-200 dark:bg-blue-800 text-blue-800 dark:text-blue-200 px-1 py-1 rounded text-center">
                            <div class="font-medium">{{ hour.name }}</div>
                            <div class="text-blue-600 dark:text-blue-300">{{ hour.time_range }}</div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- View Full Details -->
                <div class="text-center">
                    <a href="/day/{{ today.strftime('%Y-%m-%d') }}" 
                       class="inline-flex items-center px-3 py-2 bg-gradient-to-r from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700 text-white rounded-lg text-xs font-medium shadow-md hover:shadow-lg transition-all duration-200 transform hover:scale-105">
                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Xem chi ti·∫øt
                    </a>
                </div>
            </div>
            {% elif general_feng_shui_today %}
            <!-- General Feng Shui Sidebar -->
            <div class="bg-gradient-to-br from-gray-50 to-slate-50 dark:from-gray-900/20 dark:to-slate-900/20 rounded-xl shadow-lg border-2 border-gray-200 dark:border-gray-700 p-4 sticky top-4">
                <div class="text-center mb-4">
                    <h3 class="text-lg font-bold bg-gradient-to-r from-gray-600 to-slate-600 bg-clip-text text-transparent dark:from-gray-400 dark:to-slate-400">
                        üîÆ Phong th·ªßy h√¥m nay
                    </h3>
                    <p class="text-sm text-gray-600 dark:text-gray-300">
                        {{ today.strftime('%d/%m/%Y') }}
                    </p>
                </div>

                <!-- Can Chi and Element -->
                <div class="mb-4 p-3 bg-gradient-to-br from-purple-100 to-purple-200 dark:from-purple-900/30 dark:to-purple-800/30 rounded-lg border border-purple-300 dark:border-purple-700">
                    <h4 class="text-sm text-purple-600 dark:text-purple-400 font-medium mb-2">üìÖ Th√¥ng tin ng√†y</h4>
                    <div class="space-y-1 text-xs">
                        <div><strong>Can Chi:</strong> {{ general_feng_shui_today.can_chi }}</div>
                        <div><strong>Ng≈© h√†nh:</strong> {{ general_feng_shui_today.element.value }}</div>
                        <div><strong>H∆∞·ªõng t·ªët:</strong> {{ general_feng_shui_today.lucky_direction }}</div>
                    </div>
                </div>

                <!-- General Activities -->
                <div class="mb-4">
                    <div class="p-3 bg-gradient-to-br from-green-100 to-emerald-100 dark:from-green-900/30 dark:to-emerald-900/30 rounded-lg border border-green-300 dark:border-green-700 mb-2">
                        <h4 class="text-sm font-semibold text-green-800 dark:text-green-200 mb-2">‚úÖ N√™n l√†m</h4>
                        <ul class="space-y-1">
                            {% for activity in general_feng_shui_today.lucky_activities[:3] %}
                            <li class="text-xs text-green-700 dark:text-green-300 flex items-start">
                                <span class="text-green-500 mr-1">‚Ä¢</span>
                                {{ activity }}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    
                    <div class="p-3 bg-gradient-to-br from-red-100 to-pink-100 dark:from-red-900/30 dark:to-pink-900/30 rounded-lg border border-red-300 dark:border-red-700">
                        <h4 class="text-sm font-semibold text-red-800 dark:text-red-200 mb-2">‚ùå N√™n tr√°nh</h4>
                        <ul class="space-y-1">
                            {% for activity in general_feng_shui_today.unlucky_activities[:3] %}
                            <li class="text-xs text-red-700 dark:text-red-300 flex items-start">
                                <span class="text-red-500 mr-1">‚Ä¢</span>
                                {{ activity }}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>

                <!-- General Colors -->
                <div class="mb-4 p-3 bg-gradient-to-br from-yellow-100 to-orange-100 dark:from-yellow-900/30 dark:to-orange-900/30 rounded-lg border border-yellow-300 dark:border-yellow-700">
                    <h4 class="text-sm font-semibold text-yellow-800 dark:text-yellow-200 mb-2">üé® M√†u may m·∫Øn</h4>
                    <div class="flex flex-wrap gap-1">
                        {% for color in general_feng_shui_today.lucky_colors[:4] %}
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-200 dark:bg-yellow-800 text-yellow-800 dark:text-yellow-200">
                            {{ color }}
                        </span>
                        {% endfor %}
                    </div>
                    
                    {% if general_feng_shui_today.conflicting_zodiacs %}
                    <div class="mt-2 pt-2 border-t border-yellow-200 dark:border-yellow-700">
                        <div class="text-xs text-yellow-700 dark:text-yellow-300">
                            <strong>‚ö†Ô∏è Con gi√°p xung kh·∫Øc:</strong> {{ general_feng_shui_today.conflicting_zodiacs|join(', ') }}
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Lucky Hours -->
                <div class="mb-4 p-3 bg-gradient-to-br from-blue-100 to-cyan-100 dark:from-blue-900/30 dark:to-cyan-900/30 rounded-lg border border-blue-300 dark:border-blue-700">
                    <h4 class="text-sm font-semibold text-blue-800 dark:text-blue-200 mb-2">‚è∞ Gi·ªù ho√†ng ƒë·∫°o</h4>
                    <div class="grid grid-cols-2 gap-1">
                        {% for hour in general_feng_shui_today.lucky_hours[:4] %}
                        <div class="text-xs bg-blue-200 dark:bg-blue-800 text-blue-800 dark:text-blue-200 px-1 py-1 rounded text-center">
                            <div class="font-medium">{{ hour.name }}</div>
                            <div class="text-blue-600 dark:text-blue-300">{{ hour.time_range }}</div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Encourage to register/add birth date -->
                {% if current_user %}
                <div class="text-center p-3 bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/30 dark:to-indigo-900/30 rounded-lg border border-blue-200 dark:border-blue-700">
                    <div class="text-2xl mb-1">üéØ</div>
                    <p class="text-xs text-blue-600 dark:text-blue-300 mb-2">
                        Th√™m ng√†y sinh ƒë·ªÉ nh·∫≠n phong th·ªßy c√° nh√¢n h√≥a
                    </p>
                    <a href="/auth/profile" 
                       class="inline-flex items-center px-2 py-1 bg-blue-500 hover:bg-blue-600 text-white rounded text-xs font-medium">
                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                        C·∫≠p nh·∫≠t
                    </a>
                </div>
                {% else %}
                <div class="text-center p-3 bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/30 dark:to-emerald-900/30 rounded-lg border border-green-200 dark:border-green-700">
                    <div class="text-2xl mb-1">üöÄ</div>
                    <p class="text-xs text-green-600 dark:text-green-300 mb-2">
                        ƒêƒÉng nh·∫≠p ƒë·ªÉ nh·∫≠n phong th·ªßy c√° nh√¢n h√≥a
                    </p>
                    <a href="/login" 
                       class="inline-flex items-center px-2 py-1 bg-green-500 hover:bg-green-600 text-white rounded text-xs font-medium">
                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path>
                        </svg>
                        ƒêƒÉng nh·∫≠p
                    </a>
                </div>
                {% endif %}

                <!-- View Full Details -->
                <div class="text-center mt-4">
                    <a href="/day/{{ today.strftime('%Y-%m-%d') }}" 
                       class="inline-flex items-center px-3 py-2 bg-gradient-to-r from-gray-500 to-slate-600 hover:from-gray-600 hover:to-slate-700 text-white rounded-lg text-xs font-medium shadow-md hover:shadow-lg transition-all duration-200 transform hover:scale-105">
                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Xem chi ti·∫øt
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Google Calendar Holidays (National) -->
    {% if google_calendar_configured %}
    {% set national_holidays = [] %}
    {% for date_str, holidays in holidays_by_date.items() %}
        {% for holiday in holidays %}
            {% if holiday.type == 'national' %}
                {% set holiday_with_date = holiday.copy() %}
                {% set _ = holiday_with_date.update({'date_str': date_str}) %}
                {% set date_parts = date_str.split('-') %}
                {% set holiday_date = date_parts[2] + '/' + date_parts[1] + '/' + date_parts[0] %}
                {% set _ = holiday_with_date.update({'formatted_date': holiday_date}) %}
                {% set _ = national_holidays.append(holiday_with_date) %}
            {% endif %}
        {% endfor %}
    {% endfor %}
    
    {% if national_holidays %}
    <div class="bg-gradient-to-r from-green-50 to-emerald-50 dark:from-gray-800 dark:to-gray-700 rounded-xl shadow-lg border-2 border-green-200 dark:border-gray-600 p-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold bg-gradient-to-r from-green-600 to-emerald-600 bg-clip-text text-transparent dark:from-green-400 dark:to-emerald-400">
                üáªüá≥ Ng√†y l·ªÖ qu·ªëc gia th√°ng {{ current_month }}/{{ current_year }}
            </h2>
            <div class="text-xs text-green-600 dark:text-green-400 font-medium">
                üì° Google Calendar
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for holiday in national_holidays %}
            <div class="bg-gradient-to-br from-green-100 to-emerald-100 dark:from-green-900/20 dark:to-emerald-900/20 border-2 border-green-300 dark:border-green-700 rounded-xl p-4 shadow-md hover:shadow-lg transition-all duration-200 transform hover:scale-105">
                <div class="font-bold text-green-800 dark:text-green-200 text-lg">üáªüá≥ {{ holiday.name }}</div>
                <div class="text-sm text-green-600 dark:text-green-300 mt-1">
                    üìÖ {{ holiday.formatted_date }}
                </div>
                {% if holiday.description %}
                <div class="text-xs text-green-500 dark:text-green-400 mt-1">
                    üí¨ {{ holiday.description }}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <div class="bg-gradient-to-r from-gray-50 to-gray-100 dark:from-gray-800 dark:to-gray-700 rounded-xl shadow-lg border-2 border-gray-200 dark:border-gray-600 p-6">
        <div class="text-center">
            <h2 class="text-xl font-bold text-gray-600 dark:text-gray-400 mb-2">
                üáªüá≥ Ng√†y l·ªÖ qu·ªëc gia
            </h2>
            <p class="text-gray-500 dark:text-gray-400">
                Kh√¥ng c√≥ ng√†y l·ªÖ qu·ªëc gia n√†o trong th√°ng {{ current_month }}/{{ current_year }}
            </p>
        </div>
    </div>
    {% endif %}
    {% else %}
    <div class="bg-gradient-to-r from-yellow-50 to-orange-50 dark:from-gray-800 dark:to-gray-700 rounded-xl shadow-lg border-2 border-yellow-200 dark:border-gray-600 p-6">
        <div class="text-center">
            <h2 class="text-xl font-bold text-yellow-600 dark:text-yellow-400 mb-2">
                ‚ö†Ô∏è Google Calendar ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh
            </h2>
            <p class="text-yellow-600 dark:text-yellow-400 text-sm">
                ƒê·ªÉ hi·ªÉn th·ªã ng√†y l·ªÖ qu·ªëc gia, vui l√≤ng c·∫•u h√¨nh Google Calendar API key trong file c·∫•u h√¨nh.
            </p>
        </div>
    </div>
    {% endif %}

    <!-- Lunar Holidays -->
    {% set lunar_holidays_month = [] %}
    {% for holiday in lunar_holidays %}
        {% if holiday.solar_date.month == current_month %}
            {% set _ = lunar_holidays_month.append(holiday) %}
        {% endif %}
    {% endfor %}
    
    {% if lunar_holidays_month %}
    <div class="bg-gradient-to-r from-red-50 to-pink-50 dark:from-gray-800 dark:to-gray-700 rounded-xl shadow-lg border-2 border-red-200 dark:border-gray-600 p-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold bg-gradient-to-r from-red-600 to-pink-600 bg-clip-text text-transparent dark:from-red-400 dark:to-pink-400">
                üéâ Ng√†y l·ªÖ √¢m l·ªãch th√°ng {{ current_month }}/{{ current_year }}
            </h2>
            <div class="text-xs text-red-600 dark:text-red-400 font-medium">
                üåô √Çm l·ªãch truy·ªÅn th·ªëng
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for holiday in lunar_holidays_month %}
            <div class="bg-gradient-to-br from-red-100 to-pink-100 dark:from-red-900/20 dark:to-pink-900/20 border-2 border-red-300 dark:border-red-700 rounded-xl p-4 shadow-md hover:shadow-lg transition-all duration-200 transform hover:scale-105">
                <div class="font-bold text-red-800 dark:text-red-200 text-lg">üèÆ {{ holiday.name }}</div>
                <div class="text-sm text-red-600 dark:text-red-300 mt-1">
                    üìÖ {{ holiday.solar_date.strftime('%d/%m/%Y') }}
                </div>
                <div class="text-xs text-red-500 dark:text-red-400 mt-1">
                    üí¨ √Çm l·ªãch: {{ holiday.lunar_date }}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <div class="bg-gradient-to-r from-gray-50 to-gray-100 dark:from-gray-800 dark:to-gray-700 rounded-xl shadow-lg border-2 border-gray-200 dark:border-gray-600 p-6">
        <div class="text-center">
            <h2 class="text-xl font-bold text-gray-600 dark:text-gray-400 mb-2">
                üèÆ Ng√†y l·ªÖ √¢m l·ªãch
            </h2>
            <p class="text-gray-500 dark:text-gray-400">
                Kh√¥ng c√≥ ng√†y l·ªÖ √¢m l·ªãch n√†o trong th√°ng {{ current_month }}/{{ current_year }}
            </p>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    let formVisible = false;

    // Toggle note form
    function toggleNoteForm() {
        const container = document.getElementById('note-form-container');
        const addIcon = document.getElementById('add-icon');
        const buttonText = document.getElementById('button-text');
        const buttonIcon = document.getElementById('button-icon');

        if (!formVisible) {
            // Show form (use the existing /notes/new endpoint for the form)
            htmx.ajax('GET', '/notes/new', { target: '#note-form-container', swap: 'innerHTML' });
            formVisible = true;
            
            // Update button
            addIcon.style.transform = 'rotate(45deg)';
            if (buttonText) buttonText.textContent = 'ƒê√≥ng form';
            if (buttonIcon) buttonIcon.textContent = '‚úñÔ∏è';
        } else {
            // Hide form
            container.innerHTML = '';
            formVisible = false;
            
            // Reset button
            addIcon.style.transform = 'rotate(0deg)';
            if (buttonText) buttonText.textContent = 'Th√™m ghi ch√∫';
            if (buttonIcon) buttonIcon.textContent = '‚ûï';
        }
    }

    // Change date function
    function changeDate() {
        const month = document.getElementById('month-selector').value;
        const year = document.getElementById('year-selector').value;
        window.location.href = `/?year=${year}&month=${month}`;
    }

    // Add loading states to navigation buttons
    document.addEventListener('htmx:beforeRequest', function(evt) {
        if (evt.target.classList.contains('nav-button')) {
            evt.target.classList.add('nav-loading');
            evt.target.disabled = true;
        }
    });

    document.addEventListener('htmx:afterRequest', function(evt) {
        if (evt.target.classList.contains('nav-button')) {
            evt.target.classList.remove('nav-loading');
            evt.target.disabled = false;
        }
    });
</script>
{% endblock %}
