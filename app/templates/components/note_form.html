<div class="bg-gradient-to-r from-gray-50 to-blue-50 dark:from-gray-700 dark:to-gray-600 rounded-xl p-6 border-2 border-blue-200 dark:border-gray-500 shadow-lg animate-slideDown">
    <h3 class="text-xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent dark:from-blue-400 dark:to-purple-400 mb-6">
        {% if note %}üìù Ch·ªânh s·ª≠a ghi ch√∫{% else %}‚ú® Th√™m ghi ch√∫ m·ªõi{% endif %}
    </h3>
    
    <form {% if note %}
            hx-post="/notes/{{ note.id }}/edit"
          {% else %}
            hx-post="/notes/new"
          {% endif %}
          hx-target="this"
          hx-swap="outerHTML"
          class="space-y-4">
        
        <!-- Title -->
        <div>
            <label for="title" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                Ti√™u ƒë·ªÅ *
            </label>
            <input type="text" 
                   id="title" 
                   name="title" 
                   value="{% if note %}{{ note.title }}{% endif %}"
                   required
                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm 
                          bg-white dark:bg-gray-800 text-gray-900 dark:text-white
                          focus:ring-primary-500 focus:border-primary-500">
        </div>
        
        <!-- Content -->
        <div>
            <label for="content" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                N·ªôi dung
            </label>
            <textarea id="content" 
                      name="content" 
                      rows="3"
                      class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm 
                             bg-white dark:bg-gray-800 text-gray-900 dark:text-white
                             focus:ring-primary-500 focus:border-primary-500">{% if note %}{{ note.content }}{% endif %}</textarea>
        </div>
        
        <!-- Date -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label for="solar_date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    Ng√†y *
                </label>
                <input type="date" 
                       id="solar_date" 
                       name="solar_date" 
                       value="{% if note %}{{ solar_date_str }}{% else %}{{ today }}{% endif %}"
                       required
                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm 
                              bg-white dark:bg-gray-800 text-gray-900 dark:text-white
                              focus:ring-primary-500 focus:border-primary-500">
            </div>
            
            <div>
                <label for="calendar_type" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    Lo·∫°i l·ªãch
                </label>
                <select id="calendar_type" 
                        name="calendar_type"
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm 
                               bg-white dark:bg-gray-800 text-gray-900 dark:text-white
                               focus:ring-primary-500 focus:border-primary-500">
                    <option value="solar" {% if not note or note.calendar_type.value == 'solar' %}selected{% endif %}>
                        D∆∞∆°ng l·ªãch
                    </option>
                    <option value="lunar" {% if note and note.calendar_type.value == 'lunar' %}selected{% endif %}>
                        √Çm l·ªãch
                    </option>
                </select>
            </div>
        </div>
        
        <!-- Notification Settings -->
        <div class="border-t border-gray-200 dark:border-gray-600 pt-4">
            <div class="flex items-center mb-3">
                <input type="checkbox" 
                       id="enable_notification" 
                       name="enable_notification" 
                       value="true"
                       {% if not note or note.enable_notification %}checked{% endif %}
                       class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 dark:border-gray-600 rounded">
                <label for="enable_notification" class="ml-2 text-sm text-gray-700 dark:text-gray-300">
                    B·∫≠t th√¥ng b√°o nh·∫Øc nh·ªü
                </label>
            </div>
            
            <div id="notification-settings" class="{% if note and not note.enable_notification %}hidden{% endif %}">
                <label for="notification_days" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    Nh·∫Øc tr∆∞·ªõc (s·ªë ng√†y)
                </label>
                <input type="number" 
                       id="notification_days" 
                       name="notification_days" 
                       value="{% if note %}{{ note.notification_days_before }}{% else %}3{% endif %}"
                       min="1"
                       max="30"
                       placeholder="3"
                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm 
                              bg-white dark:bg-gray-800 text-gray-900 dark:text-white
                              focus:ring-primary-500 focus:border-primary-500">
                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                    V√≠ d·ª•: 5 s·∫Ω nh·∫Øc t·ª´ 5 ng√†y tr∆∞·ªõc ƒë·∫øn ng√†y s·ª± ki·ªán (t·ªïng 6 th√¥ng b√°o)
                </p>
                
                <!-- Repeat Options -->
                <div class="mt-4 space-y-2">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        T√πy ch·ªçn l·∫∑p l·∫°i
                    </label>
                    
                    <!-- Monthly Repeat Option -->
                    <div class="flex items-center">
                        <input type="radio" 
                               id="monthly_repeat" 
                               name="repeat_type" 
                               value="monthly"
                               {% if note and note.monthly_repeat %}checked{% endif %}
                               class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 dark:border-gray-600">
                        <label for="monthly_repeat" class="ml-2 text-sm text-gray-700 dark:text-gray-300">
                            üìÖ L·∫∑p l·∫°i h√†ng th√°ng
                        </label>
                    </div>
                    
                    <!-- Yearly Repeat Option -->
                    <div class="flex items-center">
                        <input type="radio" 
                               id="yearly_repeat" 
                               name="repeat_type" 
                               value="yearly"
                               {% if note and note.yearly_repeat %}checked{% endif %}
                               class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 dark:border-gray-600">
                        <label for="yearly_repeat" class="ml-2 text-sm text-gray-700 dark:text-gray-300">
                            üîÑ L·∫∑p l·∫°i h√†ng nƒÉm
                        </label>
                    </div>
                    
                    <!-- No Repeat Option -->
                    <div class="flex items-center">
                        <input type="radio" 
                               id="no_repeat" 
                               name="repeat_type" 
                               value="none"
                               {% if not note or (not note.yearly_repeat and not note.monthly_repeat) %}checked{% endif %}
                               class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 dark:border-gray-600">
                        <label for="no_repeat" class="ml-2 text-sm text-gray-700 dark:text-gray-300">
                            ‚ùå Kh√¥ng l·∫∑p l·∫°i
                        </label>
                    </div>
                    
                    <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                        üìÖ <strong>H√†ng th√°ng:</strong> L·∫∑p l·∫°i m·ªói th√°ng v√†o c√πng ng√†y<br>
                        üîÑ <strong>H√†ng nƒÉm:</strong> L·∫∑p l·∫°i m·ªói nƒÉm v√†o c√πng ng√†y th√°ng
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Buttons -->
        <div class="flex items-center justify-end space-x-3 pt-6">
            <button type="button"
                    onclick="hideNoteForm()"
                    class="px-6 py-3 text-sm font-bold text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 border-2 border-gray-300 dark:border-gray-600 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-700 transition-all duration-200 transform hover:scale-105 shadow-md">
                ‚ùå H·ªßy
            </button>
            <button type="submit"
                    class="px-6 py-3 text-sm font-bold text-white bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 rounded-xl transition-all duration-200 transform hover:scale-105 shadow-lg hover:shadow-xl">
                {% if note %}üîÑ C·∫≠p nh·∫≠t{% else %}‚úÖ Th√™m{% endif %}
            </button>
        </div>
    </form>
</div>

<script>
    // Handle form response based on page context
    function handleFormResponse(event) {
        if (event.detail.successful) {
            const currentPath = window.location.pathname;
            
            // Check if response is a redirect (status 302)
            if (event.detail.xhr.status === 302) {
                // Follow the redirect
                window.location.href = event.detail.xhr.getResponseHeader('Location') || '/notes';
                return;
            }
            
            // For HTMX responses on notes page
            if (currentPath.includes('/notes')) {
                // Response already handled by HTMX
                return;
            }
            
            // For other pages (calendar, day view), redirect to notes
            if (currentPath === '/' || currentPath.includes('/day/')) {
                setTimeout(() => {
                    window.location.href = '/notes?success=created';
                }, 500);
            }
        }
    }

    // Hide note form function
    function hideNoteForm() {
        const container = document.getElementById('note-form-container');
        if (container) {
            container.innerHTML = '';
        }
        
        // Close modal if exists
        if (window.closeModal) {
            window.closeModal();
        }
        
        // Reset button text if on notes page
        const btnText = document.getElementById('toggle-btn-text');
        if (btnText) {
            btnText.textContent = 'Th√™m ghi ch√∫ m·ªõi';
            if (typeof formVisible !== 'undefined') {
                formVisible = false;
            }
        }
    }

    // Toggle notification settings
    document.getElementById('enable_notification').addEventListener('change', function() {
        const settings = document.getElementById('notification-settings');
        if (this.checked) {
            settings.classList.remove('hidden');
        } else {
            settings.classList.add('hidden');
        }
    });
</script>
